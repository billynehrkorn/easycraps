<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Easy Craps Game</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap');

    body {
        font-family: Arial, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        background-color: #0f5132; /* Base green color */
        background-image: radial-gradient(circle at center, rgba(15, 81, 50, 0.8) 0%, rgba(15, 81, 50, 1) 70%),
                          repeating-linear-gradient(45deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 2px, transparent 2px, transparent 4px); /* Subtle radial gradient and pattern */
        color: white;
        position: relative;
    }

    .header {
        text-align: center;
        position: relative;
    }

    .header h1 {
        font-family: 'Dancing Script', cursive;
        color: #ffd700;
        font-size: 48px;
        margin: 0;
    }

    /* New styles for the top info bar */
    .top-info-bar {
        position: absolute; /* Position absolutely */
        right: -40px; /* Align to the right */
        display: flex;
        flex-direction: row; /* Arrange left-stats and right-stats in a row */
        gap: 30px; /* Space between the two main stat groups */
        align-items: flex-start; /* Align items to the top within the bar */
        padding: 10px 5px;
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        color: #ffd700;
        font-size: 20px;
        font-weight: bold;
        z-index: 10; /* Ensure it's above other elements if needed */
    }

    .left-stats {
        display: flex;
        flex-direction: column; /* Stack Last Bet and Last Win */
        align-items: flex-end; /* Align text to the right */
        gap: 5px; /* Smaller gap between stacked items */
        font-size: 9px; /* Smaller font for Last Bet/Win */
    }

    .right-stats {
        display: flex;
        flex-direction: row; /* Arrange Playable and Bet in a row */
        align-items: center; /* Vertically align items in the row */
        gap: 30px; /* Space between Playable and Bet */
    }

    .stat-item {
        white-space: nowrap; /* Prevent wrapping */
    }

    .dice-result {
        text-align: center;
        margin: 10px auto 0px auto; /* Updated margin */
        font-size: 20px;
        max-width: 800px;
    }

    .dice {
        display: inline-block;
        width: 50px;
        height: 50px;
        background-color: white;
        color: black;
        border-radius: 8px;
        line-height: 50px;
        margin: 0 10px;
        font-size: 24px;
        font-weight: bold;
    }

    .notifications {
        text-align: center;
        margin-bottom: 10px;
        min-height: 30px; /* Reduced min-height */
    }

    .notification-message {
        font-family: 'Dancing Script', cursive; /* Fancy font */
        font-size: 24px; /* Smaller font size from 32px */
        font-weight: bold;
        padding: 5px 10px; /* Reduced padding */
        border-radius: 8px;
        display: inline-block; /* To allow background/padding */
        margin-top: 8px;
    }

    .notification-message.win {
        color: #28a745;
        background-color: rgba(40, 167, 69, 0.1);
    }

    .notification-message.lose {
        color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
    }

    .notification-message.no-win {
        color: #ffd700;
        background-color: rgba(255, 215, 0, 0.1);
    }

    .controls {
        text-align: center;
        margin: 10px 0;
    }

    .roll-btn, .clear-btn {
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin: 0 10px;
    }

    .roll-btn {
        background-color: #dc3545;
        border-radius: 100px;
    }

    .roll-btn:hover {
        background-color: #c82333;
    }

    .roll-btn:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .clear-btn {
        background-color: #6c757d;
    }

    .clear-btn:hover {
        background-color: #5a6268;
    }

    #number-bets {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        width: 100%;
        overflow-x: auto;
    }

    .bet-box {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: center;
        min-width: 70px;
        flex-shrink: 0;
        position: relative; /* For stacking chips */
        min-height: 100px; /* Ensure enough space for chips */
        max-height: 100px; /* Updated max-height */
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* Push label/payout to top, chips to bottom */
        align-items: center;
    }

    .bet-box label {
        display: block;
        font-size: 50px; /* Updated font size */
        font-weight: bold;
        color: #fff;
    }

    .bet-box .payout-text {
        font-size: 12px;
        color: #ccc;
        margin-bottom: 5px;
        display: block;
    }

    .bet-box input {
        width: 50px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
    }

    .seven-and-field-container {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 20px;
        max-width: 900px; /* Constrain max-width for the flex container */
        margin-left: auto;
        margin-right: auto;
    }

    .seven-bet {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: center;
        min-width: 70px;
        flex-shrink: 0;
        position: relative; /* For stacking chips */
        min-height: 100px; /* Ensure enough space for chips */
        max-height: 100px; /* Updated max-height */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
    }

    .seven-bet label {
        display: block;
        font-size: 30px; /* Updated font size */
        font-weight: bold;
        color: #dc5442;
        margin-bottom: 8px;
    }

    .seven-bet .payout-text {
        font-size: 12px;
        color: #ccc;
        margin-bottom: 5px;
        display: block;
    }

    .seven-bet input {
        width: 50px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
    }

    .field-container {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 20px;
        flex: 1; /* Allow it to grow but respect max-width of parent */
        min-width: 400px; /* Ensure it doesn't get too small */
    }

    .field-header { /* New style for the "Field" text */
        text-align: center;
        color: #ffd700;
        font-size: 25px; /* Requested font size */
        font-weight: bold;
        margin-bottom: 15px;
    }

    .field-numbers-container {
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative; /* For stacking chips */
        min-height: 100px; /* Ensure enough space for chips */
        max-height: 100px; /* Updated max-height */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
    }

    .field-numbers {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 12px;
    }

    .field-number {
        padding: 12px; /* Updated padding */
        border-radius: 4px;
        font-weight: bold;
        color: #fff;
        background-color: transparent; /* Removed background color */
    }

    .field-number-circle { /* New style for 2 and 12 */
        background-color: rgba(255, 255, 255, 0.1);
        width: 40px; /* Make it square for circle */
        height: 40px; /* Make it square for circle */
        border-radius: 50%; /* Make it a circle */
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #000;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .field-input-container {
        text-align: center;
        position: relative; /* For stacking chips */
        min-height: 60px; /* Ensure enough space for chips */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .field-input-container label {
        display: block;
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 14px;
    }

    .field-input-container input {
        width: 60px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
    }

    .field-bets {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .field-bet-section {
        background-color: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 4px;
        text-align: center;
        position: relative; /* For stacking chips */
        min-height: 100px; /* Ensure enough space for chips */
        max-height: 100px; /* Updated max-height */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
    }

    .field-bet-section h4 {
        margin: 0 0 10px 0;
        color: #ffd700;
        font-size: 17px; /* Updated font size from 14px */
    }

    .field-bet-section .numbers {
        background-color: rgba(255, 255, 255, 0.1); /* Re-added background */
        padding: 8px 12px;
        border-radius: 4px;
        font-weight: bold;
        color: #fff;
    }

    .field-bet-section input {
        width: 60px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
    }

    #chip-bar {
        display: flex;
        justify-content: center;
        gap: 15px; /* Increased gap for better spacing */
        margin-top: 30px;
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        min-height: 80px; /* Make it a clear drop target */
    }

    .chip {
        width: 60px; /* Slightly larger for better appearance */
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 20px;
        color: white;
        border: 3px solid rgba(255, 255, 255, 0.4); /* Thicker border */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        cursor: grab; /* Indicate draggable */
        transition: transform 0.1s ease-in-out;
        flex-shrink: 0; /* Prevent chips from shrinking */
    }

    .chip:hover {
        transform: translateY(-3px);
    }

    /* Chip Colors */
    .chip-1 { background-color: #cccccc; color: #333; } /* Light Gray */
    .chip-2 { background-color: #dc3545; } /* Red */
    .chip-3 { background-color: #007bff; } /* Blue */
    .chip-5 { background-color: #28a745; } /* Green */
    .chip-10 { background-color: #343a40; } /* Dark Gray/Black */
    .chip-25 { background-color: #6f42c1; } /* Purple */
    .chip-50 { background-color: #fd7e14; } /* Orange */
    .chip-100 { background-color: #ffc107; color: #333; } /* Gold/Yellow */
    .chip-custom { background-color: #1a704a; color: white; } /* Default for non-standard sums */

    /* Drag and Drop styles */
    .drag-over {
        border: 2px dashed #ffd700 !important; /* Highlight droppable area */
        background-color: rgba(255, 215, 0, 0.1) !important;
    }

    /* New styles for bet display */
    .bet-display {
        position: relative;
        width: 60px; /* Match chip width */
        height: 60px; /* Match chip height */
        margin-top: auto; /* Push to bottom of flex container */
        margin-bottom: 5px; /* Space from bottom */
        display: flex;
        justify-content: center;
        align-items: flex-end; /* Stack chips from bottom up */
    }

    .bet-display .chip {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 50px; /* Slightly smaller for stacked effect */
        height: 50px;
        font-size: 16px;
        border-width: 2px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }
</style>
</head>
<body>
<div class="top-info-bar">
    <div class="left-stats">
        <div class="stat-item">Last Bet: $<span id="last-bet">0.00</span></div>
        <div class="stat-item">Last Win: $<span id="last-win">0.00</span></div>
    </div>
    <div class="right-stats">
        <div class="stat-item">Playable: $<span id="playable-balance">500.00</span></div>
        <div class="stat-item">Bet: $<span id="total-bet">0.00</span></div>
    </div>
</div>

<div class="header">
    <h1>ðŸŽ² Easy Craps ðŸŽ²</h1>
</div>

<div class="dice-result" id="diceResult">
    <div><span class="dice" id="dice1">1</span> <span class="dice" id="dice2">1</span></div>
</div>

<div class="notifications" id="notifications">
    <div class="notification-message" style="text-align: center; color: #ffd700;">Place your bets and roll the dice!</div>
</div>

<div class="controls">
    <button class="roll-btn" id="rollBtn" onclick="rollDice()">ROLL</button>
    <button class="clear-btn" onclick="clearAllBets()">Clear Bets</button>
</div>

<div id="number-bets">
    <div class="bet-box" data-bet-target="bet-2">
        <label for="bet-2">2</label>
        <span class="payout-text">pays 11 to 2</span>
        <div class="bet-display" id="bet-display-2"></div>
        <input type="hidden" id="bet-2" name="bet-2" min="0" step="1" value="0">
    </div>
    <div class="bet-box" data-bet-target="bet-3">
        <label for="bet-3">3</label>
        <span class="payout-text">pays 11 to 4</span>
        <div class="bet-display" id="bet-display-3"></div>
        <input type="hidden" id="bet-3" name="bet-3" min="0" step="1" value="0">
    </div>
    <div class="bet-box" data-bet-target="bet-4">
        <label for="bet-4">4</label>
        <span class="payout-text">pays 9 to 5</span>
        <div class="bet-display" id="bet-display-4"></div>
        <input type="hidden" id="bet-4" name="bet-4" min="0" step="1" value="0">
    </div>
    <div class="bet-box" data-bet-target="bet-5">
        <label for="bet-5">5</label>
        <span class="payout-text">pays 7 to 5</span>
        <div class="bet-display" id="bet-display-5"></div>
        <input type="hidden" id="bet-5" name="bet-5" min="0" step="1" value="0">
    </div>
    <div class="bet-box" data-bet-target="bet-6">
        <label for="bet-6">6</label>
        <span class="payout-text">pays 7 to 6</span>
        <div class="bet-display" id="bet-display-6"></div>
        <input type="hidden" id="bet-6" name="bet-6" min="0" step="1" value="0">
    </div>
    <div class="bet-box" data-bet-target="bet-8">
        <label for="bet-8">8</label>
        <span class="payout-text">pays 7 to 6</span>
        <div class="bet-display" id="bet-display-8"></div>
        <input type="hidden" id="bet-8" name="bet-8" min="0" step="1" value="0">
    </div>
    <div class="bet-box" data-bet-target="bet-9">
        <label for="bet-9">9</label>
        <span class="payout-text">pays 7 to 5</span>
        <div class="bet-display" id="bet-display-9"></div>
        <input type="hidden" id="bet-9" name="bet-9" min="0" step="1" value="0">
    </div>
    <div class="bet-box" data-bet-target="bet-10">
        <label for="bet-10">10</label>
        <span class="payout-text">pays 9 to 5</span>
        <div class="bet-display" id="bet-display-10"></div>
        <input type="hidden" id="bet-10" name="bet-10" min="0" step="1" value="0">
    </div>
    <div class="bet-box" data-bet-target="bet-11">
        <label for="bet-11">11</label>
        <span class="payout-text">pays 11 to 4</span>
        <div class="bet-display" id="bet-display-11"></div>
        <input type="hidden" id="bet-11" name="bet-11" min="0" step="1" value="0">
    </div>
    <div class="bet-box" data-bet-target="bet-12">
        <label for="bet-12">12</label>
        <span class="payout-text">pays 11 to 2</span>
        <div class="bet-display" id="bet-display-12"></div>
        <input type="hidden" id="bet-12" name="bet-12" min="0" step="1" value="0">
    </div>
</div>

<div class="seven-and-field-container">
    <div class="seven-bet" data-bet-target="bet-seven">
        <label for="bet-seven">21 to 5 - SEVEN - 21 to 5</label>
        <div class="bet-display" id="bet-display-seven"></div>
        <input type="hidden" id="bet-seven" name="bet-seven" min="0" step="1" value="0">
    </div>

    <div class="field-container">
        <div class="field-numbers-container" data-bet-target="bet-field">
            <label style="font-size: 17px; font-weight: bold; display: block; margin-bottom: 10px; text-align: center; color: #ffd700;">Field</label>
            <div class="field-numbers">
                <div class="field-number-circle">2</div>
                <div class="field-number">3</div>
                <div class="field-number">4</div>
                <div class="field-number">9</div>
                <div class="field-number">10</div>
                <div class="field-number">11</div>
                <div class="field-number-circle">12</div>
            </div>
            <div class="field-input-container">
                <div class="bet-display" id="bet-display-field"></div>
                <input type="hidden" id="bet-field" min="0" step="1" value="0">
            </div>
        </div>
        <div class="field-bets">
            <div class="field-bet-section" data-bet-target="bet-lowField">
                <h4>Low Field</h4>
                <div class="numbers">2, 3, 4</div>
                <div class="bet-display" id="bet-display-lowField"></div>
                <input type="hidden" id="bet-lowField" min="0" step="1" value="0">
            </div>
            <div class="field-bet-section" data-bet-target="bet-highField">
                <h4>High Field</h4>
                <div class="numbers">10, 11, 12</div>
                <div class="bet-display" id="bet-display-highField"></div>
                <input type="hidden" id="bet-highField" min="0" step="1" value="0">
            </div>
        </div>
    </div>
</div>

<div id="chip-bar">
    <div class="chip chip-1" draggable="true" data-value="1">$1</div>
    <div class="chip chip-2" draggable="true" data-value="2">$2</div>
    <div class="chip chip-3" draggable="true" data-value="3">$3</div>
    <div class="chip chip-5" draggable="true" data-value="5">$5</div>
    <div class="chip chip-10" draggable="true" data-value="10">$10</div>
    <div class="chip chip-25" draggable="true" data-value="25">$25</div>
    <div class="chip chip-50" draggable="true" data-value="50">$50</div>
    <div class="chip chip-100" draggable="true" data-value="100">$100</div>
</div>

<script>
    const betInputIds = [
        'bet-2', 'bet-3', 'bet-4', 'bet-5', 'bet-6', 'bet-8', 'bet-9', 'bet-10', 'bet-11', 'bet-12',
        'bet-field', 'bet-lowField', 'bet-highField', 'bet-seven'
    ];

    const chipDenominations = [100, 50, 25, 10, 5, 3, 2, 1]; // Used for initial chip bar
    const chipColors = {
        1: '#cccccc',
        2: '#dc3545',
        3: '#007bff',
        5: '#28a745',
        10: '#343a40',
        25: '#6f42c1',
        50: '#fd7e14',
        100: '#ffc107'
    };
    const chipTextColors = {
        1: '#333',
        100: '#333'
    };

    // Global variable for player's actual total balance (cash + staked)
    let currentBalance = 500;

    // Generate or retrieve session ID
    let sessionId = localStorage.getItem('crapsSessionId');
    if (!sessionId) {
        sessionId = crypto.randomUUID(); // Generate a unique ID
        localStorage.setItem('crapsSessionId', sessionId);
    }

    function getChipStyle(value) {
        let bgColor = '#1a704a'; // Default background for custom sums (a slightly lighter green)
        let textColor = 'white';

        if (chipColors[value]) {
            bgColor = chipColors[value];
            textColor = chipTextColors[value] || 'white';
        }
        return { bgColor, textColor };
    }

    function renderBetChip(fullBetInputId, amount) {
        const cleanBetId = fullBetInputId.replace('bet-', '');
        const displayContainer = document.getElementById(`bet-display-${cleanBetId}`);
        if (!displayContainer) {
            console.error(`Display container for ${cleanBetId} (derived from ${fullBetInputId}) not found.`);
            return;
        }

        displayContainer.innerHTML = ''; // Clear existing chips

        if (amount === 0) {
            return; // No chip to display if amount is 0
        }

        const chipDiv = document.createElement('div');
        const { bgColor, textColor } = getChipStyle(amount);

        chipDiv.className = `chip`; // Use base chip class
        chipDiv.textContent = `$${amount}`;
        chipDiv.style.backgroundColor = bgColor;
        chipDiv.style.color = textColor;

        chipDiv.draggable = true;
        chipDiv.dataset.betId = fullBetInputId; // Store the full ID for dragging off
        chipDiv.dataset.value = amount; // Store the total value it represents for removal

        // Apply styles for positioning within bet-display
        chipDiv.style.position = 'absolute';
        chipDiv.style.bottom = '0';
        chipDiv.style.left = '50%';
        chipDiv.style.transform = 'translateX(-50%)';
        chipDiv.style.width = '50px';
        chipDiv.style.height = '50px';
        chipDiv.style.fontSize = '16px';
        chipDiv.style.borderWidth = '2px';
        chipDiv.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.4)';

        chipDiv.addEventListener('dragstart', (e) => {
            e.stopPropagation(); // Prevent parent dragstart if any
            e.dataTransfer.setData('text/plain', JSON.stringify({
                betId: e.target.dataset.betId,
                value: parseInt(e.target.dataset.value)
            }));
            e.dataTransfer.effectAllowed = 'move'; // Indicate it's a move operation
            e.target.style.opacity = '0.5'; // Visual cue for dragging
        });

        chipDiv.addEventListener('dragend', (e) => {
            e.target.style.opacity = '1'; // Reset opacity after drag
        });

        displayContainer.appendChild(chipDiv);
    }

    function calculateTotalStakedChips() {
        let totalStaked = 0;
        betInputIds.forEach(betId => {
            totalStaked += parseFloat(document.getElementById(betId).value) || 0;
        });
        return totalStaked;
    }

    function updateTotalBetAndPlayableDisplay() {
        const totalBet = calculateTotalStakedChips();
        document.getElementById('total-bet').textContent = totalBet.toFixed(2);
        // Playable balance is total money minus money currently staked
        document.getElementById('playable-balance').textContent = (currentBalance - totalBet).toFixed(2);
    }

    function clearAllBets() { // Function for the "Clear Bets" button
        betInputIds.forEach(betId => {
            const inputElement = document.getElementById(betId);
            if (inputElement) {
                inputElement.value = '0'; // Clear the bet amount
                renderBetChip(betId, 0); // Clear visual chip
            }
        });
        updateTotalBetAndPlayableDisplay(); // Update displays after clearing all bets
    }

    async function rollDice() {
        const rollBtn = document.getElementById('rollBtn');
        rollBtn.disabled = true;
        rollBtn.textContent = 'Rolling...';

        const bets = {};
        let totalBets = 0;
        betInputIds.forEach(betId => {
            const value = parseFloat(document.getElementById(betId).value) || 0;
            bets[betId.replace('bet-', '')] = value; // Remove 'bet-' prefix for backend
            totalBets += value;
        });

        if (totalBets === 0) {
            alert('Please place at least one bet!');
            rollBtn.disabled = false;
            rollBtn.textContent = 'ROLL';
            return;
        }

        try {
            const response = await fetch('/roll', { // Use relative URL
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ bets, sessionId }) // Include sessionId
            });

            const result = await response.json();

            document.getElementById('dice1').textContent = result.dice[0];
            document.getElementById('dice2').textContent = result.dice[1];

            currentBalance = result.newBalance; // Update global currentBalance from backend response

            document.getElementById('last-bet').textContent = result.totalStakesThisRound.toFixed(2);
            document.getElementById('last-win').textContent = result.netChangeThisRound.toFixed(2);

            displayNotifications(result.results);

            // Conditional chip clearing based on roll results
            Object.entries(result.results).forEach(([betType, betResult]) => {
                const fullBetInputId = `bet-${betType}`;
                const hiddenInput = document.getElementById(fullBetInputId);

                if (hiddenInput) {
                    if (!betResult.win && !betResult.push) { // If it's a loss
                        hiddenInput.value = '0'; // Clear the bet amount
                        renderBetChip(fullBetInputId, 0); // Clear the visual chip
                    }
                    // If it's a win or push, the chip remains on the table with its value
                    // The backend has already handled the payout/return of stake to newBalance
                }
            });

            updateTotalBetAndPlayableDisplay(); // Recalculate based on remaining chips and new balance

        } catch (error) {
            console.error('Error:', error);
            alert('Error connecting to server. Make sure the Python backend is running.');
        }

        rollBtn.disabled = false;
        rollBtn.textContent = 'ROLL';
    }

    function displayNotifications(results) {
        const notificationsContainer = document.getElementById('notifications');
        notificationsContainer.innerHTML = '';

        let notificationMessage = '';
        let notificationClass = '';
        let hasWinningBets = false;

        Object.entries(results).forEach(([betType, result]) => {
            if (result.bet > 0 && !result.push) {
                hasWinningBets = true;
                let betName = betType;
                if (betType === 'lowField') betName = 'Low Field';
                else if (betType === 'highField') betName = 'High Field';
                else if (betType === 'field') betName = 'Field';
                else if (betType === 'seven') betName = 'Seven';

                if (result.win) {
                    notificationMessage += `ðŸŽ‰ You won $${result.payout.toFixed(2)} on ${betName}! `;
                    notificationClass = 'win';
                } else {
                    notificationMessage += `ðŸ’¸ You lost $${result.bet.toFixed(2)} on ${betName}. `;
                    if (notificationClass !== 'win') {
                        notificationClass = 'lose';
                    }
                }
            }
        });

        if (!hasWinningBets && notificationMessage === '') {
            notificationMessage = 'ðŸŽ² No winning bets this round!';
            notificationClass = 'no-win';
        } else if (notificationMessage === '') {
            notificationMessage = 'Place your bets and roll the dice!';
            notificationClass = '';
        }

        const messageElement = document.createElement('div');
        messageElement.className = `notification-message ${notificationClass}`;
        messageElement.textContent = notificationMessage.trim();
        notificationsContainer.appendChild(messageElement);
    }

    async function loadGameStats() {
        try {
            const response = await fetch(`/game_stats?sessionId=${sessionId}`); // Use relative URL with sessionId
            const data = await response.json();
            currentBalance = data.balance; // Initialize currentBalance from backend
            document.getElementById('last-bet').textContent = data.lastBetTotal.toFixed(2);
            document.getElementById('last-win').textContent = data.lastWinAmount.toFixed(2);
            updateTotalBetAndPlayableDisplay(); // Initialize total bet and playable display
        } catch (error) {
            console.log('Could not load game stats from server, initializing with default balance.');
            currentBalance = 500; // Fallback if backend is not reachable or session is new
            updateTotalBetAndPlayableDisplay();
        }
    }

    // --- Drag and Drop Functionality ---
    let currentDraggedChipValue = 0; // Value of chip from chip bar

    document.querySelectorAll('.chip[draggable="true"]').forEach(chip => {
        chip.addEventListener('dragstart', (e) => {
            currentDraggedChipValue = parseInt(e.target.dataset.value);
            e.dataTransfer.setData('text/plain', currentDraggedChipValue); // For compatibility
            e.dataTransfer.effectAllowed = 'copy'; // Visual cue for copy operation
        });
    });

    // Get all droppable bet areas
    const droppableBetAreas = document.querySelectorAll('.bet-box, .seven-bet, .field-numbers-container, .field-bet-section');

    droppableBetAreas.forEach(area => {
        area.addEventListener('dragover', (e) => {
            e.preventDefault(); // Allow drop
            e.dataTransfer.dropEffect = 'copy'; // Visual cue for copy operation
            area.classList.add('drag-over'); // Add visual cue
        });

        area.addEventListener('dragleave', (e) => {
            area.classList.remove('drag-over'); // Remove visual cue
        });

        area.addEventListener('drop', (e) => {
            e.preventDefault();
            area.classList.remove('drag-over');

            const chipValue = currentDraggedChipValue; // This is from the chip bar
            const fullBetInputId = area.dataset.betTarget; // e.g., "bet-2"
            const hiddenInput = document.getElementById(fullBetInputId);

            if (!hiddenInput) {
                console.error(`Hidden input for bet target ${fullBetInputId} not found.`);
                return;
            }

            let currentBet = parseFloat(hiddenInput.value) || 0;

            // Check if there's enough playable balance for the new chip
            if (currentBalance - calculateTotalStakedChips() >= chipValue) {
                hiddenInput.value = (currentBet + chipValue).toFixed(0); // Update hidden input
                renderBetChip(fullBetInputId, parseFloat(hiddenInput.value)); // Render visual chip
                updateTotalBetAndPlayableDisplay(); // Update total bet and playable display
            } else {
                alert('Not enough balance to place this bet!');
            }
        });
    });

    // Make the chip bar droppable for chips dragged OFF the table
    const chipBar = document.getElementById('chip-bar');
    chipBar.addEventListener('dragover', (e) => {
        e.preventDefault();
        // Only allow drop if a chip is being dragged from a bet area
        if (e.dataTransfer.types.includes('text/plain')) {
            try {
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                if (data.betId) { // Check if it's a chip from a bet area
                    e.dataTransfer.dropEffect = 'move';
                    chipBar.classList.add('drag-over');
                }
            } catch (error) {
                // Not a JSON string, likely a chip from the chip bar itself
            }
        }
    });

    chipBar.addEventListener('dragleave', (e) => {
        chipBar.classList.remove('drag-over');
    });

    chipBar.addEventListener('drop', (e) => {
        e.preventDefault();
        chipBar.classList.remove('drag-over');

        try {
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const fullBetInputId = data.betId;
            const valueToRemove = data.value; // This is the TOTAL amount on the bet spot when the chip was dragged

            if (fullBetInputId && valueToRemove) {
                const hiddenInput = document.getElementById(fullBetInputId);
                if (hiddenInput) {
                    let currentBet = parseFloat(hiddenInput.value) || 0;

                    const newBetAmount = Math.max(0, currentBet - valueToRemove); // Reduce the bet on that spot
                    hiddenInput.value = newBetAmount.toFixed(0);

                    // currentBalance should NOT be modified here. It represents total money.
                    // The playable balance will correctly increase because totalBet decreases.
                    renderBetChip(fullBetInputId, newBetAmount); // Update visual chip (will disappear if 0)
                    updateTotalBetAndPlayableDisplay(); // Update total bet and playable display
                }
            }
        } catch (error) {
            console.error("Error parsing dropped data or not a chip from bet area:", error);
        }
    });

    // --- End Drag and Drop Functionality ---

    function initializeDiceDisplay() {
        const d1 = Math.floor(Math.random() * 6) + 1;
        const d2 = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice1').textContent = d1;
        document.getElementById('dice2').textContent = d2;
    }

    // Initial setup on page load
    loadGameStats().then(() => {
        // Initialize all bet chips to 0 after balance is loaded
        betInputIds.forEach(betId => {
            renderBetChip(betId, 0);
        });
        initializeDiceDisplay();
    });
</script>
</body>
</html>
